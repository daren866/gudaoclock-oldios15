name: Build Unsigned IPA for TrollStore

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest'

    - name: Install Tuist via Homebrew
      run: |
        brew update
        brew install tuist
        tuist version

    - name: Generate Project with Tuist
      run: |
        tuist generate --no-open
        ls -la *.xcodeproj || echo "检查项目文件"

    - name: Build Xcode Archive
      run: |
        PROJECT_FILE=$(find . -maxdepth 1 -name "*.xcodeproj" | head -1)
        PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
        
        # 尝试自动检测 Scheme（Tuist 默认与 target 同名）
        SCHEME_NAME="$PROJECT_NAME"
        
        xcodebuild clean archive \
          -project "$PROJECT_NAME.xcodeproj" \
          -scheme "$SCHEME_NAME" \
          -configuration Release \
          -archivePath "$PWD/build/$PROJECT_NAME.xcarchive" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -destination generic/platform=iOS \
          ENABLE_BITCODE=NO  # 对于 TrollStore 通常关闭 BITCODE

    - name: Package & Fix IPA for TrollStore
      id: package_ipa
      run: |
        PROJECT_FILE=$(find . -maxdepth 1 -name "*.xcodeproj" | head -1)
        PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
        ARCHIVE_PATH="$PWD/build/$PROJECT_NAME.xcarchive"
        
        # 查找 .app 包
        APP_BUNDLE=$(find "$ARCHIVE_PATH/Products/Applications" -name "*.app" -type d | head -1)
        if [ -z "$APP_BUNDLE" ]; then
          echo "错误：未找到 .app 包"
          exit 1
        fi
        
        APP_NAME=$(basename "$APP_BUNDLE" .app)
        APP_BINARY="$APP_BUNDLE/$APP_NAME"
        
        echo "处理应用: $APP_NAME"
        echo "二进制路径: $APP_BINARY"
        
        # 关键修复 1: 确保可执行权限
        echo "➡️ 修复可执行权限..."
        chmod +x "$APP_BINARY"
        
        # 关键修复 2: 为 TrollStore 进行伪签名
        echo "➡️ 为 TrollStore 注入权限..."
        # 安装 ldid 并进行伪签名
        brew install ldid
        ldid -S "$APP_BINARY"
        
        # 验证
        echo "✅ 修复完成。最终权限："
        ls -l "$APP_BINARY"
        
        # 打包
        IPA_DIR="$PWD/build/ipa"
        mkdir -p "$IPA_DIR/Payload"
        cp -R "$APP_BUNDLE" "$IPA_DIR/Payload/"
        cd "$IPA_DIR"
        IPA_NAME="${PROJECT_NAME}_TrollStore.ipa"
        zip -r "../$IPA_NAME" Payload
        
        # 设置输出供后续步骤使用
        echo "ipa_name=$IPA_NAME" >> $GITHUB_OUTPUT

    - name: Upload TrollStore IPA
      uses: actions/upload-artifact@v4
      with:
        name: trollstore-ipa
        path: ${{ github.workspace }}/build/*_TrollStore.ipa
        retention-days: 7
