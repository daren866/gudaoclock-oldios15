name: Build Unsigned IPA with Tuist

on:
  push:
    branches: [ main ]
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: macos-latest # 必须使用 macOS 环境

    steps:
    # 1. 检出代码
    - uses: actions/checkout@v4

    # 2. 设置 Xcode 环境 (为 xcodebuild 准备)
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest' # Tuist 通常需要较新的 Xcode

    # 3. 安装 Tuist CLI
    - name: Install Tuist
      run: |
        curl -Ls https://install.tuist.io | bash
        # 将 Tuist 添加到当前会话的 PATH 中
        TUIST_PATH="$HOME/.local/share/tuist/env/bin"
        echo "$TUIST_PATH" >> $GITHUB_PATH

    # 4. 生成 Xcode 项目文件 (.xcodeproj)
    - name: Generate Project with Tuist
      run: |
        # 在项目根目录执行生成命令
        # 这会根据 Project.swift / Workspace.swift 生成 .xcodeproj
        tuist generate --no-open
        # 列出生成的文件，用于调试
        ls -la *.xcodeproj || echo "No .xcodeproj found in root"

    # 5. 使用 xcodebuild 构建未签名的归档文件
    - name: Build Xcode Archive
      run: |
        # 关键：先查找 Tuist 刚生成的 .xcodeproj 文件
        # 假设 Tuist 在根目录生成单个 .xcodeproj，且名称与 target 匹配
        PROJECT_FILE=$(find . -maxdepth 1 -name "*.xcodeproj" | head -1)
        if [ -z "$PROJECT_FILE" ]; then
          echo "错误：未找到 .xcodeproj 文件"
          exit 1
        fi
        PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
        echo "找到项目文件: $PROJECT_NAME"
        
        # 获取 Scheme 名称（通常与项目名相同或可推断）
        SCHEME_NAME="$PROJECT_NAME" # 常见情况，可根据需要调整
        
        xcodebuild clean archive \
          -project "$PROJECT_NAME.xcodeproj" \
          -scheme "$SCHEME_NAME" \
          -configuration Release \
          -archivePath "$PWD/build/$PROJECT_NAME.xcarchive" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -destination generic/platform=iOS

    # 6. 将归档文件打包成 IPA
    - name: Package IPA from Archive
      run: |
        # 动态获取项目名和 scheme 名，确保与上一步匹配
        PROJECT_FILE=$(find . -maxdepth 1 -name "*.xcodeproj" | head -1)
        PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
        SCHEME_NAME="$PROJECT_NAME"
        
        # Tuist 生成的应用路径模式
        APP_PATH="$PWD/build/$PROJECT_NAME.xcarchive/Products/Applications/$SCHEME_NAME.app"
        IPA_DIR="$PWD/build/ipa"
        
        # 创建 IPA 结构并打包
        mkdir -p "$IPA_DIR/Payload"
        cp -R "$APP_PATH" "$IPA_DIR/Payload/"
        cd "$IPA_DIR"
        zip -r "../$PROJECT_NAME.ipa" Payload

    # 7. 上传 IPA 文件作为工作流产物
    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-ipa
        path: ${{ github.workspace }}/build/*.ipa # 匹配生成的任何 .ipa 文件
        retention-days: 7
