name: Build Unsigned IPA with Tuist

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest'

    # 关键修改：使用 Homebrew 安装 Tuist
    - name: Install Tuist via Homebrew
      run: |
        brew update
        brew install tuist
        tuist version  # 验证安装

    - name: Generate Project with Tuist
      run: |
        tuist generate --no-open
        ls -la *.xcodeproj || echo "生成后检查项目文件"

    - name: Build Xcode Archive
      run: |
        # 自动查找 Tuist 生成的项目文件
        PROJECT_FILE=$(find . -maxdepth 1 -name "*.xcodeproj" | head -1)
        if [ -z "$PROJECT_FILE" ]; then
          echo "错误：未找到 .xcodeproj 文件"
          exit 1
        fi
        PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
        echo "使用项目: $PROJECT_NAME"
        
        # 尝试自动获取 Scheme（通常与项目名相同）
        SCHEME_NAME="$PROJECT_NAME"
        
        xcodebuild clean archive \
          -project "$PROJECT_NAME.xcodeproj" \
          -scheme "$SCHEME_NAME" \
          -configuration Release \
          -archivePath "$PWD/build/$PROJECT_NAME.xcarchive" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -destination generic/platform=iOS

    - name: Package IPA from Archive
      run: |
        PROJECT_FILE=$(find . -maxdepth 1 -name "*.xcodeproj" | head -1)
        PROJECT_NAME=$(basename "$PROJECT_FILE" .xcodeproj)
        SCHEME_NAME="$PROJECT_NAME"
        
        APP_PATH="$PWD/build/$PROJECT_NAME.xcarchive/Products/Applications/$SCHEME_NAME.app"
        if [ ! -d "$APP_PATH" ]; then
          echo "警告: 标准路径未找到 .app，尝试查找..."
          # 备用方案：在 xcarchive 中查找任何 .app 文件
          APP_PATH=$(find "$PWD/build/$PROJECT_NAME.xcarchive" -name "*.app" -type d | head -1)
        fi
        
        IPA_DIR="$PWD/build/ipa"
        mkdir -p "$IPA_DIR/Payload"
        cp -R "$APP_PATH" "$IPA_DIR/Payload/"
        cd "$IPA_DIR"
        zip -r "../$PROJECT_NAME.ipa" Payload

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: unsigned-ipa
        path: ${{ github.workspace }}/build/*.ipa
        retention-days: 7
